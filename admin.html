<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>åœ–æ›¸é¤¨å¾Œå°ç®¡ç†ç³»çµ±</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .admin-container { max-width: 800px; margin: 40px auto; padding: 20px; }
        .form-card { 
            background: #fff; 
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            margin-bottom: 30px; 
            border-top: 5px solid #28a745; 
        }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-row input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        
        /* æŒ‰éˆ•èˆ‡åˆ—è¡¨æ¨£å¼ */
        .btn-add { width: 100%; background: #28a745; color: white; border: none; padding: 12px; font-size: 16px; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .btn-add:hover { background: #218838; }
        .btn-upload { background: #007bff; margin-top: 10px; } 
        .btn-upload:hover { background: #0069d9; }
        .book-list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border-bottom: 1px solid #eee; }
        .book-list-item img { width: 50px; height: auto; margin-right: 15px; border-radius: 4px; vertical-align: middle;}
        .btn-delete { background: #dc3545; color: white; border: none; padding: 8px 15px; cursor: pointer; border-radius: 4px; }
    </style>
</head>
<body>
    <nav class="top-nav">
        <div class="nav-left"><h1 class="logo-title">Library Admin (å¾Œå°)</h1></div>
        <div class="nav-right">
            <a href="index.html" style="font-weight: bold;">å›åˆ°å‰å°é¦–é  &rarr;</a>
        </div>
    </nav>

    <div class="admin-container">
        <h2>ğŸš€ æ‰¹æ¬¡åŒ¯å…¥æ›¸ç± (JSON)</h2>
        <div class="form-card" style="border-top-color: #007bff;">
            <p>è«‹é¸æ“‡çˆ¬èŸ²ç”¢ç”Ÿçš„ <code>books_data.json</code> æª”æ¡ˆï¼š</p>
            <input type="file" id="json-file-input" accept=".json">
            <button class="btn-add btn-upload" id="btn-bulk-upload">é–‹å§‹æ‰¹æ¬¡åŒ¯å…¥</button>
            <p id="upload-status" style="margin-top:10px; color:#666;"></p>
        </div>

        <h2>ğŸ“š æ‰‹å‹•æ–°å¢æ›¸ç±</h2>
        <div class="form-card">
            <div class="form-row">
                <input type="text" id="input-title" placeholder="æ›¸å">
                <input type="text" id="input-author" placeholder="ä½œè€…">
            </div>
            <div class="form-row">
                <input type="text" id="input-publisher" placeholder="å‡ºç‰ˆç¤¾">
                <input type="text" id="input-price" placeholder="åƒ¹æ ¼">
            </div>
            <button class="btn-add" id="btn-add-book">ï¼‹ ç¢ºèªæ–°å¢æ›¸ç±</button>
        </div>

        <h2>ğŸ“– è³‡æ–™åº«åº«å­˜åˆ—è¡¨</h2>
        <div id="admin-book-list" style="background:white; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
            <p style="padding:20px; color:#666;">è¼‰å…¥ä¸­...</p>
        </div>
    </div>

    <script type="module">
        import { db } from './js/firebase-config.js';
        import { collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const bookListEl = document.getElementById('admin-book-list');
        const btnAdd = document.getElementById('btn-add-book');
        const btnBulkUpload = document.getElementById('btn-bulk-upload');
        const fileInput = document.getElementById('json-file-input');
        const statusText = document.getElementById('upload-status');

        // 1. ç›£è½æ›¸ç±åˆ—è¡¨ (ä¾å»ºç«‹æ™‚é–“æ’åº)
        function loadAdminBooks() {
            const q = query(collection(db, "books"), orderBy("createdAt", "desc"));
            onSnapshot(q, (querySnapshot) => {
                bookListEl.innerHTML = '';
                if (querySnapshot.empty) {
                    bookListEl.innerHTML = '<p style="padding:20px;">è³‡æ–™åº«æ˜¯ç©ºçš„ã€‚</p>';
                    return;
                }
                querySnapshot.forEach((docSnap) => {
                    const book = docSnap.data();
                    const div = document.createElement('div');
                    div.className = 'book-list-item';
                    div.innerHTML = `
                        <div style="display:flex; align-items:center;">
                            <img src="${book.image || 'https://via.placeholder.com/50'}" alt="cover">
                            <div>
                                <strong style="font-size:16px;">${book.title}</strong>
                                <br><span style="color:#666; font-size:13px;">${book.author} | $${book.price} | ISBN: ${book.isbn || 'ç„¡'}</span>
                            </div>
                        </div>
                        <button class="btn-delete" data-id="${docSnap.id}">åˆªé™¤</button>
                    `;
                    bookListEl.appendChild(div);
                });
                document.querySelectorAll('.btn-delete').forEach(btn => btn.addEventListener('click', deleteBook));
            });
        }

        // 2. æ‰¹æ¬¡åŒ¯å…¥åŠŸèƒ½
        btnBulkUpload.addEventListener('click', async () => {
            const file = fileInput.files[0];
            if (!file) { alert("è«‹å…ˆé¸æ“‡ JSON æª”æ¡ˆï¼"); return; }
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const booksData = JSON.parse(e.target.result);
                    statusText.textContent = `è®€å–æˆåŠŸï¼Œæº–å‚™åŒ¯å…¥ ${booksData.length} æœ¬æ›¸...`;
                    let count = 0;
                    for (const book of booksData) {
                        await addDoc(collection(db, "books"), {
                            title: book.title,
                            author: book.author || 'æœªçŸ¥ä½œè€…',
                            publisher: 'å¤©ç“æ›¸å±€',
                            price: book.price,
                            isbn: book.isbn,
                            // è¨­å®šåœ–ç‰‡è·¯å¾‘æŒ‡å‘æ‚¨çš„ images è³‡æ–™å¤¾
                            image: book.image_filename ? `./images/${book.image_filename}` : 'https://via.placeholder.com/150',
                            availability: 'In Stock',
                            createdAt: new Date()
                        });
                        count++;
                        statusText.textContent = `é€²åº¦ï¼šå·²åŒ¯å…¥ ${count} / ${booksData.length} æœ¬...`;
                    }
                    statusText.textContent = `âœ… å…¨æ•¸åŒ¯å…¥å®Œæˆï¼`;
                    statusText.style.color = "green";
                } catch (err) {
                    console.error(err);
                    alert("åŒ¯å…¥å¤±æ•—");
                }
            };
            reader.readAsText(file);
        });

        // 3. æ‰‹å‹•æ–°å¢åŠŸèƒ½
        async function addBook() {
            const title = document.getElementById('input-title').value.trim();
            const author = document.getElementById('input-author').value.trim();
            const publisher = document.getElementById('input-publisher').value.trim();
            const price = document.getElementById('input-price').value.trim();
            if(!title || !author) { alert("æ›¸åä½œè€…å¿…å¡«"); return; }
            await addDoc(collection(db, "books"), {
                title, author, publisher, price, 
                image: 'https://via.placeholder.com/150', 
                createdAt: new Date()
            });
            document.querySelectorAll('input').forEach(i => i.value = '');
        }

        async function deleteBook(e) {
            const id = e.target.getAttribute('data-id');
            if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) await deleteDoc(doc(db, "books", id));
        }

        btnAdd.addEventListener('click', addBook);
        loadAdminBooks();
    </script>
</body>
</html>        .btn-add:hover { background: #218838; }
        
        /* åˆ—è¡¨æ¨£å¼ */
        .book-list-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px; 
            background: white;
            border-bottom: 1px solid #eee; 
        }
        .book-list-item:first-child { border-top-left-radius: 8px; border-top-right-radius: 8px; }
        .book-list-item:last-child { border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; border-bottom: none; }
        
        .btn-delete { 
            background: #dc3545; 
            color: white; 
            border: none; 
            padding: 8px 15px; 
            cursor: pointer; 
            border-radius: 4px; 
        }
        .btn-delete:hover { background: #c82333; }
    </style>
</head>
<body>
    <nav class="top-nav">
        <div class="nav-left"><h1 class="logo-title">Library Admin (å¾Œå°)</h1></div>
        <div class="nav-right">
            <a href="index.html" style="font-weight: bold;">å›åˆ°å‰å°é¦–é  &rarr;</a>
        </div>
    </nav>

    <div class="admin-container">
        <h2>ğŸ“š æ–°å¢æ›¸ç±å…¥åº«</h2>
        <div class="form-card">
            <div class="form-row">
                <input type="text" id="input-title" placeholder="æ›¸å (ä¾‹å¦‚ï¼šå“ˆåˆ©æ³¢ç‰¹)">
                <input type="text" id="input-author" placeholder="ä½œè€… (ä¾‹å¦‚ï¼šJ.K. ç¾…ç³)">
            </div>
            <div class="form-row">
                <input type="text" id="input-publisher" placeholder="å‡ºç‰ˆç¤¾ (ä¾‹å¦‚ï¼šçš‡å† æ–‡åŒ–)">
                <input type="text" id="input-price" placeholder="åƒ¹æ ¼ (ä¾‹å¦‚ï¼š450)">
            </div>
            <button class="btn-add" id="btn-add-book">ï¼‹ ç¢ºèªæ–°å¢æ›¸ç±</button>
        </div>

        <h2>ğŸ“– ç›®å‰è³‡æ–™åº«åº«å­˜</h2>
        <div id="admin-book-list" style="background:white; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
            <p style="padding:20px; color:#666;">è¼‰å…¥ä¸­...</p>
        </div>
    </div>

    <script type="module">
        // 1. å¼•å…¥æˆ‘å€‘å‰›å‰›è¨­å®šå¥½çš„ db (å¾ firebase-config.js)
        import { db } from './js/firebase-config.js';
        
        // 2. å¼•å…¥ Firebase çš„æ“ä½œå·¥å…· (æ–°å¢ã€è®€å–ã€åˆªé™¤ã€æ’åº)
        import { collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, onSnapshot } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // æŠ“å–ç•«é¢ä¸Šçš„å…ƒä»¶
        const bookListEl = document.getElementById('admin-book-list');
        const btnAdd = document.getElementById('btn-add-book');

        // --- åŠŸèƒ½ Aï¼šå³æ™‚ç›£è½ä¸¦é¡¯ç¤ºæ›¸ç±åˆ—è¡¨ ---
        function loadAdminBooks() {
            // æŒ‡å®šè¦çœ‹ 'books' é€™å€‹é›†åˆï¼Œä¸¦ä¾ç…§ 'title' æ’åº
            const q = query(collection(db, "books"), orderBy("title"));

            // onSnapshot æ˜¯ä¸€å€‹å¼·å¤§çš„åŠŸèƒ½ï¼šè³‡æ–™åº«ä¸€æœ‰è®Šå‹•ï¼Œç•«é¢æœƒè‡ªå‹•æ›´æ–°ï¼
            onSnapshot(q, (querySnapshot) => {
                bookListEl.innerHTML = ''; // æ¸…ç©ºèˆŠåˆ—è¡¨
                
                if (querySnapshot.empty) {
                    bookListEl.innerHTML = '<p style="padding:20px; text-align:center;">ç›®å‰è³‡æ–™åº«æ˜¯ç©ºçš„ï¼Œå¿«æ–°å¢ä¸€æœ¬æ›¸å§ï¼</p>';
                    return;
                }

                querySnapshot.forEach((docSnap) => {
                    const book = docSnap.data();
                    const div = document.createElement('div');
                    div.className = 'book-list-item';
                    
                    // é€™è£¡ç”¢ç”Ÿæ¯ä¸€è¡Œçš„ HTML
                    div.innerHTML = `
                        <div>
                            <strong style="font-size:18px;">${book.title}</strong> 
                            <span style="color:#666; margin-left:10px;">ğŸ‘¤ ${book.author}</span>
                            <br>
                            <span style="font-size:12px; color:#999;">ğŸ  ${book.publisher} | ğŸ’° $${book.price}</span>
                        </div>
                        <button class="btn-delete" data-id="${docSnap.id}">åˆªé™¤</button>
                    `;
                    bookListEl.appendChild(div);
                });

                // é‡æ–°ç¶å®šåˆªé™¤æŒ‰éˆ•çš„äº‹ä»¶
                document.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.addEventListener('click', deleteBook);
                });
            });
        }

        // --- åŠŸèƒ½ Bï¼šæ–°å¢æ›¸ç± ---
        async function addBook() {
            const title = document.getElementById('input-title').value.trim();
            const author = document.getElementById('input-author').value.trim();
            const publisher = document.getElementById('input-publisher').value.trim();
            const price = document.getElementById('input-price').value.trim();

            if(!title || !author) {
                alert("âŒ æ›¸åå’Œä½œè€…æ˜¯å¿…å¡«çš„å–”ï¼");
                return;
            }

            // æŒ‰éˆ•è®Šæ›´ç‹€æ…‹é¿å…é‡è¤‡æŒ‰
            btnAdd.textContent = "è™•ç†ä¸­...";
            btnAdd.disabled = true;

            try {
                // å°‡è³‡æ–™æ‰“åŒ…é€å» Firebase
                await addDoc(collection(db, "books"), {
                    title: title,
                    author: author,
                    publisher: publisher,
                    price: price,
                    image: 'https://via.placeholder.com/150', // æš«æ™‚ç”¨å‡åœ–ï¼Œä¹‹å¾Œå¯æ”¹
                    availability: 'In Stock',
                    createdAt: new Date() // ç´€éŒ„å»ºç«‹æ™‚é–“
                });

                alert("âœ… æ–°å¢æˆåŠŸï¼");
                // æ¸…ç©ºè¼¸å…¥æ¡†
                document.querySelectorAll('input').forEach(i => i.value = '');
            } catch (e) {
                console.error("Error adding document: ", e);
                alert("âŒ æ–°å¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Console");
            } finally {
                // æ¢å¾©æŒ‰éˆ•
                btnAdd.textContent = "ï¼‹ ç¢ºèªæ–°å¢æ›¸ç±";
                btnAdd.disabled = false;
            }
        }

        // --- åŠŸèƒ½ Cï¼šåˆªé™¤æ›¸ç± ---
        async function deleteBook(e) {
            // å–å¾—è—åœ¨æŒ‰éˆ•è£¡çš„ ID
            const id = e.target.getAttribute('data-id');
            
            if(confirm('âš ï¸ ç¢ºå®šè¦å¾è³‡æ–™åº«æ°¸ä¹…åˆªé™¤é€™æœ¬æ›¸å—ï¼Ÿ')) {
                try {
                    await deleteDoc(doc(db, "books", id));
                    // é€™è£¡ä¸ç”¨å¯« alertï¼Œå› ç‚ºä¸Šé¢çš„ onSnapshot æœƒè‡ªå‹•æ›´æ–°ç•«é¢
                } catch (e) {
                    console.error("Error deleting: ", e);
                    alert("åˆªé™¤å¤±æ•—");
                }
            }
        }

        // ç¶å®šæŒ‰éˆ•é»æ“Šäº‹ä»¶
        btnAdd.addEventListener('click', addBook);

        // ç¨‹å¼ä¸€å•Ÿå‹•å°±é–‹å§‹è¼‰å…¥åˆ—è¡¨
        loadAdminBooks();
    </script>
</body>
</html>
