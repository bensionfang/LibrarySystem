<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>åœ–æ›¸é¤¨å¾Œå°ç®¡ç†ç³»çµ±</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        .admin-container { max-width: 800px; margin: 40px auto; padding: 20px; }
        .form-card { 
            background: #fff; padding: 30px; border-radius: 8px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 30px; 
            border-top: 5px solid #28a745; 
        }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-row input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        
        .btn-add { width: 100%; background: #28a745; color: white; border: none; padding: 12px; font-size: 16px; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .btn-add:hover { background: #218838; }
        .btn-upload { background: #6f42c1; margin-top: 10px; } /* ç´«è‰²æŒ‰éˆ•ä»£è¡¨ ZIP åŠŸèƒ½ */
        .btn-upload:hover { background: #5a32a3; }
        
        .book-list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border-bottom: 1px solid #eee; }
        .book-list-item img { width: 50px; height: 70px; object-fit: cover; margin-right: 15px; border-radius: 4px; vertical-align: middle;}
        .btn-delete { background: #dc3545; color: white; border: none; padding: 8px 15px; cursor: pointer; border-radius: 4px; }
        
        /* é€²åº¦æ¢æ¨£å¼ */
        .progress-bar { width: 100%; background-color: #e9ecef; border-radius: 4px; margin-top: 10px; height: 10px; overflow: hidden; display: none; }
        .progress-fill { height: 100%; background-color: #28a745; width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>
    <nav class="top-nav">
        <div class="nav-left"><h1 class="logo-title">Library Admin (å¾Œå°)</h1></div>
        <div class="nav-right">
            <a href="index.html" style="font-weight: bold;">å›åˆ°å‰å°é¦–é  &rarr;</a>
        </div>
    </nav>

    <div class="admin-container">
        <h2>ğŸ“¦ è¶…ç´šåŒ¯å…¥ (æ”¯æ´ ZIP: JSON + åœ–ç‰‡)</h2>
        <div class="form-card" style="border-top-color: #6f42c1;">
            <p>è«‹ä¸Šå‚³åŒ…å« <code>.json</code> èˆ‡åœ–ç‰‡æª”çš„ <strong>ZIP å£“ç¸®æª”</strong>ï¼š</p>
            <input type="file" id="zip-file-input" accept=".zip">
            <button class="btn-add btn-upload" id="btn-zip-upload">é–‹å§‹ ZIP åŒ¯å…¥</button>
            
            <div class="progress-bar" id="progress-container">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <p id="upload-status" style="margin-top:10px; color:#666; font-size: 14px; white-space: pre-line;"></p>
            
            <div style="margin-top: 15px; padding: 10px; background: #f3e5f5; font-size: 13px; color: #4a148c; border-radius: 4px;">
                <strong>ğŸ’¡ ZIP çµæ§‹èªªæ˜ï¼š</strong><br>
                1. å¿…é ˆåŒ…å«ä¸€å€‹ JSON æª” (ä¾‹å¦‚ books.json)ã€‚<br>
                2. JSON è£¡çš„ <code>image</code> æ¬„ä½è«‹ç›´æ¥å¯«æª”å (ä¾‹å¦‚ "harry_potter.jpg")ã€‚<br>
                3. åœ–ç‰‡æª”æ¡ˆè«‹ä¸€èµ·æ”¾åœ¨ ZIP è£¡ï¼Œç³»çµ±æœƒè‡ªå‹•ä¸Šå‚³åˆ°é›²ç«¯ä¸¦é€£çµï¼
            </div>
        </div>

        <h2>ğŸ“š æ‰‹å‹•æ–°å¢æ›¸ç±</h2>
        <div class="form-card">
            <div class="form-row">
                <input type="text" id="input-title" placeholder="æ›¸å (å¿…å¡«)">
                <input type="text" id="input-author" placeholder="ä½œè€… (å¿…å¡«)">
            </div>
            <div class="form-row">
                <input type="text" id="input-publisher" placeholder="å‡ºç‰ˆç¤¾">
                <input type="text" id="input-price" placeholder="åƒ¹æ ¼">
            </div>
            <div class="form-row">
                <input type="text" id="input-image" placeholder="åœ–ç‰‡ç¶²å€ (æˆ–ç•™ç©ºä½¿ç”¨é è¨­åœ–)">
                <input type="text" id="input-isbn" placeholder="ISBN">
            </div>
            <button class="btn-add" id="btn-add-book">ï¼‹ ç¢ºèªæ–°å¢æ›¸ç±</button>
        </div>

        <h2>ğŸ“– è³‡æ–™åº«åº«å­˜åˆ—è¡¨</h2>
        <div id="admin-book-list" style="background:white; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
            <p style="padding:20px; color:#666;">è¼‰å…¥ä¸­...</p>
        </div>
    </div>

    <script type="module">
        // å¼•å…¥ db å’Œ storage
        import { db, storage } from './js/firebase-config.js';
        import { collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        // å¼•å…¥ Storage ä¸Šå‚³åŠŸèƒ½
        import { ref, uploadBytes, getDownloadURL } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const bookListEl = document.getElementById('admin-book-list');
        const btnAdd = document.getElementById('btn-add-book');
        const btnZipUpload = document.getElementById('btn-zip-upload');
        const zipInput = document.getElementById('zip-file-input');
        const statusText = document.getElementById('upload-status');
        const progressContainer = document.getElementById('progress-container');
        const progressFill = document.getElementById('progress-fill');

        // --- 1. ZIP åŒ¯å…¥æ ¸å¿ƒé‚è¼¯ ---
        btnZipUpload.addEventListener('click', async () => {
            const file = zipInput.files[0];
            if (!file) { alert("è«‹å…ˆé¸æ“‡ ZIP æª”æ¡ˆï¼"); return; }

            try {
                // UI ç‹€æ…‹é‡ç½®
                btnZipUpload.disabled = true;
                statusText.textContent = "â³ æ­£åœ¨è§£å£“ç¸® ZIP...";
                statusText.style.color = "#666";
                progressContainer.style.display = 'block';
                progressFill.style.width = '5%';

                // A. è§£å£“ç¸® ZIP
                const zip = await JSZip.loadAsync(file);
                
                // B. å°‹æ‰¾ JSON æª”æ¡ˆ
                let jsonFile = null;
                let imageFiles = {}; // æª”å -> ZipObject å°æ˜ 

                zip.forEach((relativePath, zipEntry) => {
                    if (zipEntry.name.endsWith('.json')) {
                        jsonFile = zipEntry;
                    } else if (zipEntry.name.match(/\.(jpg|jpeg|png|gif)$/i)) {
                        // è™•ç†è·¯å¾‘ï¼šç§»é™¤è³‡æ–™å¤¾å‰ç¶´ï¼Œåªç•™æª”å (ä¾‹å¦‚ "imgs/cover.jpg" -> "cover.jpg")
                        const fileName = zipEntry.name.split('/').pop(); 
                        imageFiles[fileName] = zipEntry;
                    }
                });

                if (!jsonFile) { throw new Error("ZIP æª”å…§æ‰¾ä¸åˆ° .json è³‡æ–™æª”ï¼"); }

                // C. è®€å– JSON å…§å®¹
                const jsonContent = await jsonFile.async("string");
                const booksData = JSON.parse(jsonContent);

                if (!Array.isArray(booksData)) { throw new Error("JSON æ ¼å¼éŒ¯èª¤ï¼šå¿…é ˆæ˜¯é™£åˆ— [...]"); }

                statusText.textContent = `ğŸ“¦ è®€å–æˆåŠŸï¼æº–å‚™åŒ¯å…¥ ${booksData.length} æœ¬æ›¸ç±...\næ­£åœ¨ä¸Šå‚³åœ–ç‰‡è‡³é›²ç«¯ï¼Œè«‹ç¨å€™...`;
                
                let successCount = 0;
                const total = booksData.length;

                // D. é€ç­†è™•ç†
                for (let i = 0; i < total; i++) {
                    const book = booksData[i];
                    let finalImageUrl = 'https://via.placeholder.com/150?text=No+Image';

                    // è™•ç†åœ–ç‰‡ï¼šæª¢æŸ¥ JSON è£¡çš„ image æ¬„ä½æ˜¯å¦æœ‰å°æ‡‰ ZIP è£¡çš„æª”æ¡ˆ
                    // æ¬„ä½åç¨±æ”¯æ´ image, image_filename, cover
                    const imgNameInJson = book.image || book.image_filename || book.cover;
                    
                    if (imgNameInJson && imageFiles[imgNameInJson]) {
                        // 1. å¾ ZIP è®€å–åœ–ç‰‡ Blob
                        const imgBlob = await imageFiles[imgNameInJson].async("blob");
                        
                        // 2. è¨­å®šä¸Šå‚³è·¯å¾‘ (åŠ ä¸Šæ™‚é–“æˆ³è¨˜é¿å…æª”åé‡è¤‡)
                        const uniqueName = `book_covers/${Date.now()}_${imgNameInJson}`;
                        const storageRef = ref(storage, uniqueName);
                        
                        // 3. ä¸Šå‚³åˆ° Firebase Storage
                        await uploadBytes(storageRef, imgBlob);
                        
                        // 4. å–å¾—æ°¸ä¹…ç¶²å€ (Download URL)
                        finalImageUrl = await getDownloadURL(storageRef);
                    } else if (imgNameInJson && imgNameInJson.startsWith('http')) {
                        // å¦‚æœæœ¬ä¾†å°±æ˜¯ç¶²è·¯åœ–ç‰‡
                        finalImageUrl = imgNameInJson;
                    }

                    // E. å¯«å…¥è³‡æ–™åº«
                    await addDoc(collection(db, "books"), {
                        title: book.title || 'æœªå‘½å',
                        author: book.author || 'æœªçŸ¥ä½œè€…',
                        publisher: book.publisher || '',
                        price: book.price || 0,
                        isbn: book.isbn || '',
                        image: finalImageUrl, // é€™è£¡æ˜¯é›²ç«¯ç¶²å€
                        availability: 'In Stock',
                        createdAt: new Date()
                    });

                    successCount++;
                    // æ›´æ–°é€²åº¦æ¢
                    const percentage = Math.round((successCount / total) * 100);
                    progressFill.style.width = `${percentage}%`;
                    statusText.textContent = `ğŸš€ æ­£åœ¨åŒ¯å…¥... (${successCount}/${total})\nå‰›è™•ç†å®Œï¼š${book.title}`;
                }

                statusText.textContent = `âœ… åŒ¯å…¥å®Œæˆï¼æˆåŠŸåŠ å…¥ ${successCount} æœ¬æ›¸ç±ã€‚`;
                statusText.style.color = "green";
                zipInput.value = ''; // æ¸…ç©º

            } catch (err) {
                console.error(err);
                statusText.textContent = `âŒ éŒ¯èª¤ï¼š${err.message}`;
                statusText.style.color = "red";
                alert("åŒ¯å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Console æˆ– ZIP æ ¼å¼");
            } finally {
                btnZipUpload.disabled = false;
            }
        });

        // --- 2. ç›£è½æ›¸ç±åˆ—è¡¨ (èˆ‡ä¹‹å‰ç›¸åŒ) ---
        function loadAdminBooks() {
            const q = query(collection(db, "books"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                bookListEl.innerHTML = '';
                if (snapshot.empty) { bookListEl.innerHTML = '<p style="padding:20px;">ç›®å‰æ²’æœ‰æ›¸ç±</p>'; return; }
                snapshot.forEach(docSnap => {
                    const book = docSnap.data();
                    const div = document.createElement('div');
                    div.className = 'book-list-item';
                    div.innerHTML = `
                        <div style="display:flex; align-items:center;">
                            <img src="${book.image}" alt="cover" onerror="this.src='https://via.placeholder.com/150'">
                            <div>
                                <strong>${book.title}</strong>
                                <br><span style="color:#666; font-size:12px;">${book.author} | $${book.price}</span>
                            </div>
                        </div>
                        <button class="btn-delete" data-id="${docSnap.id}">åˆªé™¤</button>
                    `;
                    bookListEl.appendChild(div);
                });
                document.querySelectorAll('.btn-delete').forEach(btn => btn.addEventListener('click', deleteBook));
            });
        }

        // --- 3. æ‰‹å‹•æ–°å¢ (ç²¾ç°¡ç‰ˆ) ---
        async function addBook() {
            const title = document.getElementById('input-title').value.trim();
            const author = document.getElementById('input-author').value.trim();
            const img = document.getElementById('input-image').value.trim();
            if(!title || !author) { alert("æ›¸åä½œè€…å¿…å¡«"); return; }
            btnAdd.disabled = true;
            await addDoc(collection(db, "books"), {
                title, author, 
                publisher: document.getElementById('input-publisher').value,
                price: document.getElementById('input-price').value,
                isbn: document.getElementById('input-isbn').value,
                image: img || 'https://via.placeholder.com/150',
                createdAt: new Date()
            });
            alert("æ–°å¢æˆåŠŸ");
            document.querySelectorAll('input').forEach(i=>i.value='');
            btnAdd.disabled = false;
        }

        async function deleteBook(e) {
            if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) await deleteDoc(doc(db, "books", e.target.getAttribute('data-id')));
        }

        btnAdd.addEventListener('click', addBook);
        loadAdminBooks();
    </script>
</body>
</html>
