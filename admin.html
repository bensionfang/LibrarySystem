<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <title>åœ–æ›¸é¤¨å¾Œå°ç®¡ç†ç³»çµ± - å¿«é€ŸåŒ¯å…¥ç‰ˆ</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        .admin-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
        }

        .form-card {
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            border-top: 5px solid #28a745;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .btn-add {
            width: 100%;
            background: #28a745;
            color: white;
            border: none;
            padding: 12px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
        }

        .btn-add:hover {
            background: #218838;
        }

        .btn-upload {
            background: #6f42c1;
            margin-top: 10px;
        }

        .btn-upload:hover {
            background: #5a32a3;
        }

        .book-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border-bottom: 1px solid #eee;
        }

        .book-list-item img {
            width: 50px;
            height: 70px;
            object-fit: cover;
            margin-right: 15px;
            border-radius: 4px;
            vertical-align: middle;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 4px;
        }

        .progress-bar {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 4px;
            margin-top: 10px;
            height: 10px;
            overflow: hidden;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background-color: #28a745;
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>

<body>
    <nav class="top-nav">
        <div class="nav-left">
            <h1 class="logo-title">Library Admin (å¿«é€ŸåŒ¯å…¥ç‰ˆ)</h1>
        </div>
        <div class="nav-right">
            <a href="index.html" style="font-weight: bold;">å›åˆ°å‰å°é¦–é  &rarr;</a>
        </div>
    </nav>

    <div class="admin-container">
        <h2>ğŸ“¦ è¶…ç´šåŒ¯å…¥ (å¿«é€Ÿç¶²å€é€£çµç‰ˆ)</h2>
        <div class="form-card" style="border-top-color: #6f42c1;">
            <p>è«‹ä¸Šå‚³åŒ…å« <code>books_data.json</code> çš„ <strong>ZIP å£“ç¸®æª”</strong>ï¼š</p>
            <input type="file" id="zip-file-input" accept=".zip">
            <button class="btn-add btn-upload" id="btn-zip-upload">é–‹å§‹å¿«é€ŸåŒ¯å…¥</button>

            <div class="progress-bar" id="progress-container">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <p id="upload-status" style="margin-top:10px; color:#666; font-size: 14px; white-space: pre-line;"></p>

            <div
                style="margin-top: 15px; padding: 10px; background: #e3f2fd; font-size: 13px; color: #0d47a1; border-radius: 4px;">
                <strong>ğŸ’¡ é‹ä½œèªªæ˜ï¼š</strong><br>
                1. ç³»çµ±å°‡ç›´æ¥ä½¿ç”¨ JSON ä¸­çš„ <code>original_url</code> ä½œç‚ºåœ–ç‰‡ä¾†æºã€‚<br>
                2. <strong>ä¸éœ€è¦ä¸Šå‚³åœ–ç‰‡åˆ° Storage</strong>ï¼Œé¿é–‹è¨ˆè²»æ–¹æ¡ˆé™åˆ¶ã€‚<br>
                3. åŒ¯å…¥é€Ÿåº¦æ¥µå¿«ï¼Œä¸”ç¯€çœé›²ç«¯ç©ºé–“ã€‚
            </div>
        </div>

        <h2>ğŸ“š æ‰‹å‹•æ–°å¢æ›¸ç±</h2>
        <div class="form-card">
            <div class="form-row">
                <input type="text" id="input-title" placeholder="æ›¸å (å¿…å¡«)">
                <input type="text" id="input-author" placeholder="ä½œè€… (å¿…å¡«)">
            </div>
            <div class="form-row">
                <input type="text" id="input-publisher" placeholder="å‡ºç‰ˆç¤¾">
                <input type="text" id="input-price" placeholder="åƒ¹æ ¼">
            </div>
            <div class="form-row">
                <input type="text" id="input-image" placeholder="åœ–ç‰‡ç¶²å€">
                <input type="text" id="input-isbn" placeholder="ISBN">
            </div>
            <button class="btn-add" id="btn-add-book">ï¼‹ ç¢ºèªæ–°å¢æ›¸ç±</button>
        </div>

        <h2>ğŸ“– è³‡æ–™åº«åº«å­˜åˆ—è¡¨</h2>
        <div id="admin-book-list" style="background:white; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
            <p style="padding:20px; color:#666;">è¼‰å…¥ä¸­...</p>
        </div>
    </div>

    <script type="module">
        import { db } from './js/firebase-config.js';
        import { collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc }
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const bookListEl = document.getElementById('admin-book-list');
        const btnAdd = document.getElementById('btn-add-book');
        const btnZipUpload = document.getElementById('btn-zip-upload');
        const zipInput = document.getElementById('zip-file-input');
        const statusText = document.getElementById('upload-status');
        const progressContainer = document.getElementById('progress-container');
        const progressFill = document.getElementById('progress-fill');

        btnZipUpload.addEventListener('click', async () => {
            const file = zipInput.files[0];
            if (!file) { alert("è«‹å…ˆé¸æ“‡ ZIP æª”æ¡ˆï¼"); return; }

            try {
                btnZipUpload.disabled = true;
                statusText.textContent = "â³ æ­£åœ¨è®€å– JSON è³‡æ–™...";
                statusText.style.color = "#666";
                progressContainer.style.display = 'block';
                progressFill.style.width = '0%';

                const zip = await JSZip.loadAsync(file);
                let jsonFile = null;

                // A. å°‹æ‰¾ JSON æª”æ¡ˆ
                zip.forEach((relativePath, zipEntry) => {
                    if (zipEntry.name.toLowerCase().endsWith('.json')) {
                        jsonFile = zipEntry;
                    }
                });

                if (!jsonFile) { throw new Error("ZIP å…§æ‰¾ä¸åˆ° .json æª”æ¡ˆï¼"); }

                const jsonContent = await jsonFile.async("string");
                const booksData = JSON.parse(jsonContent);

                if (!Array.isArray(booksData) || booksData.length === 0) {
                    throw new Error("JSON è³‡æ–™æ ¼å¼éŒ¯èª¤æˆ–ç‚ºç©ºã€‚");
                }

                statusText.textContent = `ğŸ“¦ æº–å‚™åŒ¯å…¥ ${booksData.length} æœ¬æ›¸ç±...`;

                let successCount = 0;
                const total = booksData.length;

                // D. é€ç­†è™•ç† (è·³é Storage ä¸Šå‚³)
                for (let i = 0; i < total; i++) {
                    const book = booksData[i];

                    // ã€æ ¸å¿ƒä¿®æ­£ã€‘ï¼šç›´æ¥ä½¿ç”¨çˆ¬èŸ²æŠ“åˆ°çš„åŸå§‹åœ–ç‰‡ç¶²å€
                    let finalImageUrl = book.original_url || book.image || 'https://via.placeholder.com/150';

                    // å¯«å…¥ Firestore
                    await addDoc(collection(db, "books"), {
                        title: book.title || 'æœªå‘½å',
                        author: book.author || 'å¤©ç“ç²¾é¸',
                        publisher: book.publisher || 'å¤©ç“',
                        price: book.price || 0,
                        isbn: book.isbn || '',
                        image: finalImageUrl, // å„²å­˜å¤–éƒ¨åœ–ç‰‡ç¶²å€
                        availability: 'In Stock',
                        createdAt: new Date()
                    });

                    successCount++;
                    const percentage = Math.round((successCount / total) * 100);
                    progressFill.style.width = `${percentage}%`;
                    statusText.textContent = `ğŸš€ å¿«é€ŸåŒ¯å…¥é€²åº¦: ${successCount}/${total}\nå·²è™•ç†: ${book.title}`;
                }

                statusText.textContent = `âœ… åŒ¯å…¥æˆåŠŸï¼å·²å°‡ ${successCount} æœ¬æ›¸ç±é€£çµå­˜å…¥é›²ç«¯è³‡æ–™åº«ã€‚`;
                statusText.style.color = "green";
                zipInput.value = '';

            } catch (err) {
                console.error(err);
                statusText.textContent = `âŒ éŒ¯èª¤ï¼š${err.message}`;
                statusText.style.color = "red";
            } finally {
                btnZipUpload.disabled = false;
            }
        });

        // ç›£è½åˆ—è¡¨èˆ‡æ–°å¢åŠŸèƒ½
        function loadAdminBooks() {
            const q = query(collection(db, "books"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                bookListEl.innerHTML = '';
                if (snapshot.empty) { bookListEl.innerHTML = '<p style="padding:20px;">è³‡æ–™åº«ç›®å‰æ˜¯ç©ºçš„</p>'; return; }
                snapshot.forEach(docSnap => {
                    const book = docSnap.data();
                    const div = document.createElement('div');
                    div.className = 'book-list-item';
                    div.innerHTML = `
                        <div style="display:flex; align-items:center;">
                            <img src="${book.image}" onerror="this.src='https://via.placeholder.com/150'">
                            <div>
                                <strong>${book.title}</strong>
                                <br><span style="color:#666; font-size:12px;">${book.author} | $${book.price} | ISBN: ${book.isbn}</span>
                            </div>
                        </div>
                        <button class="btn-delete" data-id="${docSnap.id}">åˆªé™¤</button>
                    `;
                    bookListEl.appendChild(div);
                });
                document.querySelectorAll('.btn-delete').forEach(btn => btn.addEventListener('click', async (e) => {
                    if (confirm('ç¢ºå®šè¦å¾é›²ç«¯åˆªé™¤æ­¤æ›¸ç±ï¼Ÿ')) await deleteDoc(doc(db, "books", e.target.getAttribute('data-id')));
                }));
            });
        }

        btnAdd.addEventListener('click', async () => {
            const title = document.getElementById('input-title').value.trim();
            const author = document.getElementById('input-author').value.trim();
            if (!title || !author) { alert("æ›¸åèˆ‡ä½œè€…ç‚ºå¿…å¡«é …ç›®"); return; }
            btnAdd.disabled = true;
            await addDoc(collection(db, "books"), {
                title, author,
                publisher: document.getElementById('input-publisher').value,
                price: document.getElementById('input-price').value,
                isbn: document.getElementById('input-isbn').value,
                image: document.getElementById('input-image').value || 'https://via.placeholder.com/150',
                createdAt: new Date()
            });
            document.querySelectorAll('.form-card input').forEach(i => i.value = '');
            btnAdd.disabled = false;
            alert("æ‰‹å‹•æ–°å¢æˆåŠŸï¼");
        });

        loadAdminBooks();
    </script>
</body>

</html>