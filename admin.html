<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>åœ–æ›¸é¤¨å¾Œå°ç®¡ç†ç³»çµ±</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .admin-container { max-width: 800px; margin: 40px auto; padding: 20px; }
        .form-card { 
            background: #fff; 
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            margin-bottom: 30px; 
            border-top: 5px solid #28a745; 
        }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-row input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        
        /* æŒ‰éˆ•èˆ‡åˆ—è¡¨æ¨£å¼ */
        .btn-add { width: 100%; background: #28a745; color: white; border: none; padding: 12px; font-size: 16px; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .btn-add:hover { background: #218838; }
        .btn-upload { background: #007bff; margin-top: 10px; } 
        .btn-upload:hover { background: #0069d9; }
        .book-list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border-bottom: 1px solid #eee; }
        .book-list-item img { width: 50px; height: 70px; object-fit: cover; margin-right: 15px; border-radius: 4px; vertical-align: middle;}
        .btn-delete { background: #dc3545; color: white; border: none; padding: 8px 15px; cursor: pointer; border-radius: 4px; }
    </style>
</head>
<body>
    <nav class="top-nav">
        <div class="nav-left"><h1 class="logo-title">Library Admin (å¾Œå°)</h1></div>
        <div class="nav-right">
            <a href="index.html" style="font-weight: bold;">å›åˆ°å‰å°é¦–é  &rarr;</a>
        </div>
    </nav>

    <div class="admin-container">
        <h2>ğŸš€ æ‰¹æ¬¡åŒ¯å…¥æ›¸ç± (JSON)</h2>
        <div class="form-card" style="border-top-color: #007bff;">
            <p>è«‹é¸æ“‡çˆ¬èŸ²ç”¢ç”Ÿçš„ <code>books_data.json</code> æª”æ¡ˆï¼š</p>
            <input type="file" id="json-file-input" accept=".json">
            <button class="btn-add btn-upload" id="btn-bulk-upload">é–‹å§‹æ‰¹æ¬¡åŒ¯å…¥</button>
            <p id="upload-status" style="margin-top:10px; color:#666;"></p>
            
            <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; font-size: 13px; color: #666; border-radius: 4px;">
                <strong>ğŸ’¡ æç¤ºï¼š</strong> JSON æ¬„ä½æ”¯æ´ <code>image</code>, <code>cover</code>, <code>image_filename</code>ã€‚<br>
                å¦‚æœæ˜¯ç¶²è·¯åœ–ç‰‡æœƒç›´æ¥å„²å­˜ï¼›å¦‚æœæ˜¯æª”åæœƒè‡ªå‹•è£œä¸Š <code>./images/</code>ã€‚
            </div>
        </div>

        <h2>ğŸ“š æ‰‹å‹•æ–°å¢æ›¸ç±</h2>
        <div class="form-card">
            <div class="form-row">
                <input type="text" id="input-title" placeholder="æ›¸å (å¿…å¡«)">
                <input type="text" id="input-author" placeholder="ä½œè€… (å¿…å¡«)">
            </div>
            <div class="form-row">
                <input type="text" id="input-publisher" placeholder="å‡ºç‰ˆç¤¾">
                <input type="text" id="input-price" placeholder="åƒ¹æ ¼">
            </div>
            <div class="form-row">
                <input type="text" id="input-image" placeholder="åœ–ç‰‡é€£çµ æˆ– æª”å (ä¾‹å¦‚: cover.jpg)">
                <input type="text" id="input-isbn" placeholder="ISBN (é¸å¡«)">
            </div>
            <button class="btn-add" id="btn-add-book">ï¼‹ ç¢ºèªæ–°å¢æ›¸ç±</button>
        </div>

        <h2>ğŸ“– è³‡æ–™åº«åº«å­˜åˆ—è¡¨</h2>
        <div id="admin-book-list" style="background:white; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
            <p style="padding:20px; color:#666;">è¼‰å…¥ä¸­...</p>
        </div>
    </div>

    <script type="module">
        import { db } from './js/firebase-config.js';
        import { collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const bookListEl = document.getElementById('admin-book-list');
        const btnAdd = document.getElementById('btn-add-book');
        const btnBulkUpload = document.getElementById('btn-bulk-upload');
        const fileInput = document.getElementById('json-file-input');
        const statusText = document.getElementById('upload-status');

        // --- æ ¸å¿ƒå‡½å¼ï¼šæ™ºæ…§åˆ¤æ–·åœ–ç‰‡è·¯å¾‘ ---
        function resolveImagePath(item) {
            // 1. å˜—è©¦æŠ“å–å„ç¨®å¯èƒ½çš„æ¬„ä½åç¨±
            const rawImage = item.image || item.image_filename || item.cover || item.url || '';
            
            // 2. å¦‚æœæ˜¯ç©ºçš„ï¼Œå›å‚³å‡åœ–
            if (!rawImage) return 'https://via.placeholder.com/150?text=No+Image';

            // 3. å¦‚æœæ˜¯ http é–‹é ­ (ç¶²è·¯åœ–ç‰‡) æˆ– data:image (Base64)ï¼Œç›´æ¥å›å‚³
            if (rawImage.startsWith('http') || rawImage.startsWith('data:image')) {
                return rawImage;
            }

            // 4. å¦å‰‡å‡è¨­æ˜¯æœ¬åœ°æª”åï¼Œè£œä¸Šè·¯å¾‘
            return `./images/${rawImage}`;
        }

        // 1. ç›£è½æ›¸ç±åˆ—è¡¨ (å³æ™‚æ›´æ–°)
        function loadAdminBooks() {
            const q = query(collection(db, "books"), orderBy("createdAt", "desc"));
            onSnapshot(q, (querySnapshot) => {
                bookListEl.innerHTML = '';
                if (querySnapshot.empty) {
                    bookListEl.innerHTML = '<p style="padding:20px;">è³‡æ–™åº«æ˜¯ç©ºçš„ã€‚</p>';
                    return;
                }
                querySnapshot.forEach((docSnap) => {
                    const book = docSnap.data();
                    const div = document.createElement('div');
                    div.className = 'book-list-item';
                    
                    // é€™è£¡çš„åœ–ç‰‡é¡¯ç¤ºé‚è¼¯
                    const displayImage = book.image || 'https://via.placeholder.com/150';

                    div.innerHTML = `
                        <div style="display:flex; align-items:center;">
                            <img src="${displayImage}" alt="cover" onerror="this.src='https://via.placeholder.com/150?text=Error'">
                            <div>
                                <strong style="font-size:16px;">${book.title}</strong>
                                <br><span style="color:#666; font-size:13px;">${book.author} | $${book.price} | ISBN: ${book.isbn || 'ç„¡'}</span>
                            </div>
                        </div>
                        <button class="btn-delete" data-id="${docSnap.id}">åˆªé™¤</button>
                    `;
                    bookListEl.appendChild(div);
                });
                document.querySelectorAll('.btn-delete').forEach(btn => btn.addEventListener('click', deleteBook));
            });
        }

        // 2. æ‰¹æ¬¡åŒ¯å…¥åŠŸèƒ½ (å·²ä¿®æ­£åœ–ç‰‡é‚è¼¯)
        btnBulkUpload.addEventListener('click', async () => {
            const file = fileInput.files[0];
            if (!file) { alert("è«‹å…ˆé¸æ“‡ JSON æª”æ¡ˆï¼"); return; }
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const booksData = JSON.parse(e.target.result);
                    
                    // ç°¡å–®æª¢æŸ¥æ˜¯ä¸æ˜¯é™£åˆ—
                    if (!Array.isArray(booksData)) {
                        alert("æ ¼å¼éŒ¯èª¤ï¼šJSON å…§å®¹å¿…é ˆæ˜¯ä¸€å€‹é™£åˆ— [...]");
                        return;
                    }

                    statusText.textContent = `è®€å–æˆåŠŸï¼Œæº–å‚™åŒ¯å…¥ ${booksData.length} æœ¬æ›¸...`;
                    let count = 0;
                    
                    // ç‚ºäº†é¿å…ç¬é–“å¯«å…¥å¤ªå¿«ï¼Œé€™è£¡ç”¨ç°¡å–®çš„è¿´åœˆ
                    for (const book of booksData) {
                        
                        // â˜… å‘¼å«æ™ºæ…§åˆ¤æ–·åœ–ç‰‡è·¯å¾‘
                        const finalImagePath = resolveImagePath(book);

                        await addDoc(collection(db, "books"), {
                            title: book.title || 'ç„¡æ¨™é¡Œ',
                            author: book.author || 'æœªçŸ¥ä½œè€…',
                            publisher: book.publisher || 'æœªçŸ¥å‡ºç‰ˆç¤¾',
                            price: book.price || 0,
                            isbn: book.isbn || '',
                            image: finalImagePath, // å¯«å…¥åˆ¤æ–·å¾Œçš„è·¯å¾‘
                            availability: 'In Stock',
                            createdAt: new Date()
                        });
                        
                        count++;
                        statusText.textContent = `é€²åº¦ï¼šå·²åŒ¯å…¥ ${count} / ${booksData.length} æœ¬...`;
                    }
                    
                    statusText.textContent = `âœ… æˆåŠŸåŒ¯å…¥ ${count} æœ¬æ›¸ç±ï¼`;
                    statusText.style.color = "green";
                    
                    // æ¸…ç©ºæª”æ¡ˆè¼¸å…¥ï¼Œæ–¹ä¾¿ä¸‹æ¬¡é¸æ“‡
                    fileInput.value = '';

                } catch (err) {
                    console.error(err);
                    alert("åŒ¯å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ JSON æ ¼å¼æ˜¯å¦æ­£ç¢º (éœ€ç‚ºæ¨™æº– JSON)ã€‚");
                    statusText.textContent = "åŒ¯å…¥ç™¼ç”ŸéŒ¯èª¤";
                    statusText.style.color = "red";
                }
            };
            reader.readAsText(file);
        });

        // 3. æ‰‹å‹•æ–°å¢åŠŸèƒ½
        async function addBook() {
            const title = document.getElementById('input-title').value.trim();
            const author = document.getElementById('input-author').value.trim();
            const publisher = document.getElementById('input-publisher').value.trim();
            const price = document.getElementById('input-price').value.trim();
            const imageInput = document.getElementById('input-image').value.trim(); // åœ–ç‰‡è¼¸å…¥
            const isbn = document.getElementById('input-isbn').value.trim();

            if(!title || !author) { alert("æ›¸åèˆ‡ä½œè€…æ˜¯å¿…å¡«çš„ï¼"); return; }

            // æ‰‹å‹•æ–°å¢ä¹Ÿè¦ç”¨ä¸€æ¨£çš„é‚è¼¯åˆ¤æ–·åœ–ç‰‡
            const finalImage = resolveImagePath({ image: imageInput });

            try {
                btnAdd.disabled = true;
                btnAdd.textContent = "æ–°å¢ä¸­...";
                
                await addDoc(collection(db, "books"), {
                    title, author, publisher, price, isbn,
                    image: finalImage, 
                    availability: 'In Stock',
                    createdAt: new Date()
                });
                
                alert("âœ… æ–°å¢æˆåŠŸï¼");
                document.querySelectorAll('input').forEach(i => i.value = '');
            } catch(e) {
                console.error(e);
                alert("æ–°å¢å¤±æ•—");
            } finally {
                btnAdd.textContent = "ï¼‹ ç¢ºèªæ–°å¢æ›¸ç±";
                btnAdd.disabled = false;
            }
        }

        // 4. åˆªé™¤åŠŸèƒ½
        async function deleteBook(e) {
            const id = e.target.getAttribute('data-id');
            if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) await deleteDoc(doc(db, "books", id));
        }

        btnAdd.addEventListener('click', addBook);
        loadAdminBooks();
    </script>
</body>
</html>
