<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <title>我的書房 - LibrarySystem</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .library-container {
            max-width: 1200px;
            margin: 40px auto;
            display: flex;
            gap: 30px;
            padding: 0 20px;
        }

        .sidebar {
            width: 250px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 20px 0;
            height: fit-content;
        }

        .sidebar h3 {
            padding-left: 20px;
            margin-bottom: 10px;
            color: #4285f4;
            font-size: 18px;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-menu li {
            padding: 15px 20px;
            cursor: pointer;
            color: #555;
            border-left: 4px solid transparent;
            transition: all 0.2s;
        }

        .sidebar-menu li:hover {
            background-color: #f8f9fa;
            color: #4285f4;
        }

        .sidebar-menu li.active {
            background-color: #e8f0fe;
            color: #4285f4;
            border-left-color: #4285f4;
            font-weight: bold;
        }

        .main-content {
            flex: 1;
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            min-height: 500px;
        }

        .section-title {
            font-size: 24px;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            color: #333;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            border-bottom: 1px solid #eee;
            padding: 15px;
            text-align: left;
        }

        th {
            background-color: #f9f9f9;
            color: #555;
        }

        .profile-form .form-group {
            margin-bottom: 20px;
        }

        .profile-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .profile-form input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <nav class="top-nav">
        <div class="nav-left">
            <h1 class="logo-title" id="logo-btn">Library System</h1>
        </div>
        <div class="nav-right">
            <a id="nav-home" href="index.html">首頁</a>
            <a href="popular.html">推薦書籍</a>
            <a href="my-library.html" class="auth-link">我的書房</a>
            <a href="about.html">網站說明</a>
            <a id="btn-login-trigger" class="login-btn">登入</a>
            <a id="user-display" class="hidden" style="font-weight:bold; color:#4285f4; cursor:default;"></a>
            <a id="btn-logout" class="hidden" style="color:#d9534f;">登出</a>
        </div>
    </nav>

    <div class="library-container">
        <div class="sidebar">
            <h3>我的書房</h3>
            <ul class="sidebar-menu">
                <li id="menu-profile" onclick="switchSection('profile')" class="active">個人資料</li>
                <li id="menu-history" onclick="switchSection('history')">借閱紀錄</li>
                <li id="menu-messages" onclick="switchSection('messages')">訊息通知</li>
                <li id="menu-bookmarks" onclick="switchSection('bookmarks')">個人書籤</li>
            </ul>
        </div>

        <div class="main-content">
            <div id="section-profile" class="content-section active">
                <h2 class="section-title">個人資料</h2>
                <div class="profile-form">
                    <div class="form-group"><label>姓名</label><input type="text" value="王小明" disabled
                            style="background:#f5f5f5;"></div>
                    <div class="form-group"><label>系級</label><input type="text" value="資訊科學系" disabled
                            style="background:#f5f5f5;"></div>
                    <div class="form-group"><label>Email</label><input type="email"
                            placeholder="student@university.edu.tw"></div>
                    <div class="form-group"><label>聯絡電話</label><input type="tel" placeholder="09xx-xxx-xxx"></div>
                    <button
                        style="background:#4285f4; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">儲存修改</button>
                </div>
            </div>

            <div id="section-history" class="content-section">
                <h2 class="section-title">目前借閱與歷史紀錄</h2>
                <table>
                    <thead>
                        <tr>
                            <th>書名</th>
                            <th>借閱日期</th>
                            <th>狀態</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body">
                    </tbody>
                </table>
            </div>

            <div id="section-messages" class="content-section">
                <h2 class="section-title">訊息中心</h2>
                <p style="color:#999; text-align:center; margin-top:50px;">目前沒有新訊息</p>
            </div>

            <div id="section-bookmarks" class="content-section">
                <h2 class="section-title">我的收藏書單</h2>
                <div id="bookmarks-container" style="display:flex; flex-wrap:wrap; gap:20px;"></div>
            </div>
        </div>
    </div>

    <div id="modal-login" class="modal hidden">
        <div class="modal-content login-modal-content">
            <span class="close-btn login-close">&times;</span>
            <h2>會員登入</h2>
            <div class="login-form">
                <div class="input-group"><input type="text" id="login-user" placeholder="請輸入學號/帳號"></div>
                <div class="input-group"><input type="password" id="login-pass" placeholder="請輸入密碼"></div>
                <button id="btn-login-submit">登入</button>
            </div>
        </div>
    </div>
    <div id="toast-container"></div>

    <script type="module" src="js/main.js"></script>
    <script>
        // 切換分頁邏輯
        function switchSection(id) {
            document.querySelectorAll('.sidebar-menu li').forEach(li => li.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
            document.getElementById('menu-' + id).classList.add('active');
            document.getElementById('section-' + id).classList.add('active');

            if (id === 'bookmarks') {
                renderBookmarks();
            } else if (id === 'history') {
                renderHistory();
            }
        }

        // 渲染書籤 (已修改：支援已借閱狀態顯示)
        function renderBookmarks() {
            const container = document.getElementById('bookmarks-container');
            const bookmarkList = JSON.parse(localStorage.getItem('library_bookmarked')) || [];
            // 1. 讀取借閱紀錄
            const borrowedList = JSON.parse(localStorage.getItem('library_borrowed')) || [];

            container.innerHTML = '';

            if (bookmarkList.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#666; width:100%;">目前沒有收藏任何書籍。</p>';
                return;
            }

            bookmarkList.forEach(book => {
                // 2. 判斷是否已借閱
                const isBorrowed = borrowedList.some(b => b.id === book.id);

                const div = document.createElement('div');
                div.className = 'book-item';
                div.style.display = 'flex';
                div.style.flexDirection = 'column';
                div.style.justifyContent = 'space-between';
                div.style.border = '1px solid #eee';
                div.style.padding = '15px';
                div.style.borderRadius = '8px';

                // 3. 根據狀態切換按鈕樣式與文字
                div.innerHTML = `
                    <div style="flex-grow: 1; display: flex; flex-direction: column;"> 
                        <img src="${book.image}" alt="${book.title}" onerror="this.src='https://via.placeholder.com/150'" style="width:100%; height:200px; object-fit:contain; background-color: #f8f9fa;">
                        <h3 style="margin: 10px 0;">${book.title}</h3>
                        <div style="text-align: left; font-size: 14px; padding: 0 5px; color: #555;">
                            <p style="margin: 3px 0; color: #333;"><strong>作者：</strong>${book.author}</p>
                            <p style="margin: 3px 0;"><strong>ISBN：</strong>${book.isbn || '無'}</p>
                        </div>
                    </div>
                    <div style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px; width: 100%;">
                        <p style="color: #e4393c; font-weight: bold; font-size: 18px; margin: 0 0 10px 0;">$${book.price || 0}</p>
                        <div class="book-actions" style="display: flex; gap: 5px;">
                            <button class="${isBorrowed ? 'btn-borrow disabled' : 'btn-borrow'}" 
                                onclick="window.borrowBook('${book.id}')">
                                ${isBorrowed ? '已借閱' : '借閱'}
                            </button>
                            <button class="btn-bookmark active" onclick="window.toggleBookmark('${book.id}')" style="flex:1; padding:8px; background:#d9534f; color:white; border:1px solid #d9534f; border-radius:4px; cursor:pointer;">♥</button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // 渲染借閱紀錄
        function renderHistory() {
            const tbody = document.getElementById('history-table-body');
            const borrowedList = JSON.parse(localStorage.getItem('library_borrowed')) || [];

            tbody.innerHTML = '';

            if (borrowedList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">目前沒有借閱紀錄</td></tr>';
                return;
            }

            borrowedList.forEach(book => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${book.title}</td>
                    <td>${book.borrowDate || '2025-01-01'}</td>
                    <td><span style="color:#d9534f; font-weight:bold;">借閱中</span></td>
                    <td>
                        <button onclick="window.returnBook('${book.id}')" 
                        style="padding:5px 10px; background:#5cb85c; color:white; border:none; border-radius:4px; cursor:pointer;">
                        歸還
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 歸還功能
        window.returnBook = function (bookId) {
            if (confirm('確定要歸還這本書嗎？')) {
                let list = JSON.parse(localStorage.getItem('library_borrowed')) || [];
                list = list.filter(b => b.id !== bookId);
                localStorage.setItem('library_borrowed', JSON.stringify(list));
                renderHistory();
                window.showToast('歸還成功！', 'success');
            }
        }

        // 初始化
        window.addEventListener('DOMContentLoaded', () => {
            renderHistory();

            const u = localStorage.getItem('library_user');
            if (u) {
                const userDisplay = document.getElementById('user-display');
                if (userDisplay) {
                    userDisplay.textContent = u + " 您好";
                    userDisplay.classList.remove('hidden');
                }
                document.getElementById('btn-login-trigger')?.classList.add('hidden');
                document.getElementById('btn-logout')?.classList.remove('hidden');
            }
        });
    </script>
</body>

</html>